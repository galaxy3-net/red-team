#!/bin/bash

export PUBLIC_IP=$(dig +short myip.opendns.com @resolver1.opendns.com)
export PUBLIC_KEY=$(cat ~/.ssh/jumpbox.pub)
export ResourceGroupName="RedTeam"

export GITHUB_ROOT='https://raw.githubusercontent.com/galaxy3-net/red-team/krk/azure/arm/'

function authenticate () {
  bash -c "$(curl -s ${GITHUB_ROOT}authenticate)"
}

function day1() {
    iex redteam
    iex redteamsg
    iex nsgrules
    iex net1
    iex jumpbox
}

function iex() {
    export IEX_MODULE="${1}"
    pwsh -Command "iwr ${GITHUB_ROOT}${1}.ps1 | iex"
    #pwsh -Command "\$PUBLIC_IP=\"${PUBLIC_IP}\" ; \$Command = iwr ${URL} ; iex \$Command"
}

function refresh() {
    [ -e ./deploy ] && rm ./deploy
    wget --no-cache ${GITHUB_ROOT}deploy
    chmod u+x ./deploy
}

function setup() {
    bash -c "$(curl -s ${GITHUB_ROOT}setup)"
}

case "${1}" in

  authenticate)
    authenticate
    exit 0
    ;;

  day1)
    day1
    exit 0
    ;;

  jumpbox|net1|nsgrules|redteam|redteamsg|stub)
    iex "${1}"
    exit 0
    ;;

  refresh)
    refresh
    exit 0
    ;;

  setup)
    setup
    exit 0
    ;;

  *) echo "${1} is not a valid subcommand"
    exit 1
    ;;
esac

